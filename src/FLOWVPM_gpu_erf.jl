# Single precision constants
const erxs = 8.45062911510467529297f-01
const efxs = 1.28379167095512586316f-01
const efx8s = 1.02703333676410069053f+00
const pp0s = 1.28379167095512558561f-01
const pp1s = -3.25042107247001499370f-01
const pp2s = -2.84817495755985104766f-02
const pp3s = -5.77027029648944159157f-03
const pp4s = -2.37630166566501626084f-05
const qq1s = 3.97917223959155352819f-01
const qq2s = 6.50222499887672944485f-02
const qq3s = 5.08130628187576562776f-03
const qq4s = 1.32494738004321644526f-04
const qq5s = -3.96022827877536812320f-06

const pa0s = -2.36211856075265944077f-03
const pa1s = 4.14856118683748331666f-01
const pa2s = -3.72207876035701323847f-01
const pa3s = 3.18346619901161753674f-01
const pa4s = -1.10894694282396677476f-01
const pa5s = 3.54783043256182359371f-02
const pa6s = -2.16637559486879084300f-03
const qa1s = 1.06420880400844228286f-01
const qa2s = 5.40397917702171048937f-01
const qa3s = 7.18286544141962662868f-02
const qa4s = 1.26171219808761642112f-01
const qa5s = 1.36370839120290507362f-02
const qa6s = 1.19844998467991074170f-02

const ra0s = -9.86494403484714822705f-03
const ra1s = -6.93858572707181764372f-01
const ra2s = -1.05586262253232909814f+01
const ra3s = -6.23753324503260060396f+01
const ra4s = -1.62396669462573470355f+02
const ra5s = -1.84605092906711035994f+02
const ra6s = -8.12874355063065934246f+01
const ra7s = -9.81432934416914548592f+00
const sa1s = 1.96512716674392571292f+01
const sa2s = 1.37657754143519042600f+02
const sa3s = 4.34565877475229228821f+02
const sa4s = 6.45387271733267880336f+02
const sa5s = 4.29008140027567833386f+02
const sa6s = 1.08635005541779435134f+02
const sa7s = 6.57024977031928170135f+00
const sa8s = -6.04244152148580987438f-02

const rb0s = -9.86494292470009928597f-03
const rb1s = -7.99283237680523006574f-01
const rb2s = -1.77579549177547519889f+01
const rb3s = -1.60636384855821916062f+02
const rb4s = -6.37566443368389627722f+02
const rb5s = -1.02509513161107724954f+03
const rb6s = -4.83519191608651397019f+02
const sb1s = 3.03380607434824582924f+01
const sb2s = 3.25792512996573918826f+02
const sb3s = 1.53672958608443695994f+03
const sb4s = 3.19985821950859553908f+03
const sb5s = 2.55305040643316442583f+03
const sb6s = 4.74528541206955367215f+02
const sb7s = -2.24409524465858183362f+01

# Double precision constants
const erx = 8.45062911510467529297e-01
const efx = 1.28379167095512586316e-01
const efx8 = 1.02703333676410069053e+00
const pp0 = 1.28379167095512558561e-01
const pp1 = -3.25042107247001499370e-01
const pp2 = -2.84817495755985104766e-02
const pp3 = -5.77027029648944159157e-03
const pp4 = -2.37630166566501626084e-05
const qq1 = 3.97917223959155352819e-01
const qq2 = 6.50222499887672944485e-02
const qq3 = 5.08130628187576562776e-03
const qq4 = 1.32494738004321644526e-04
const qq5 = -3.96022827877536812320e-06

const pa0 = -2.36211856075265944077e-03
const pa1 = 4.14856118683748331666e-01
const pa2 = -3.72207876035701323847e-01
const pa3 = 3.18346619901161753674e-01
const pa4 = -1.10894694282396677476e-01
const pa5 = 3.54783043256182359371e-02
const pa6 = -2.16637559486879084300e-03
const qa1 = 1.06420880400844228286e-01
const qa2 = 5.40397917702171048937e-01
const qa3 = 7.18286544141962662868e-02
const qa4 = 1.26171219808761642112e-01
const qa5 = 1.36370839120290507362e-02
const qa6 = 1.19844998467991074170e-02

const ra0 = -9.86494403484714822705e-03
const ra1 = -6.93858572707181764372e-01
const ra2 = -1.05586262253232909814e+01
const ra3 = -6.23753324503260060396e+01
const ra4 = -1.62396669462573470355e+02
const ra5 = -1.84605092906711035994e+02
const ra6 = -8.12874355063065934246e+01
const ra7 = -9.81432934416914548592e+00
const sa1 = 1.96512716674392571292e+01
const sa2 = 1.37657754143519042600e+02
const sa3 = 4.34565877475229228821e+02
const sa4 = 6.45387271733267880336e+02
const sa5 = 4.29008140027567833386e+02
const sa6 = 1.08635005541779435134e+02
const sa7 = 6.57024977031928170135e+00
const sa8 = -6.04244152148580987438e-02

const rb0 = -9.86494292470009928597e-03
const rb1 = -7.99283237680523006574e-01
const rb2 = -1.77579549177547519889e+01
const rb3 = -1.60636384855821916062e+02
const rb4 = -6.37566443368389627722e+02
const rb5 = -1.02509513161107724954e+03
const rb6 = -4.83519191608651397019e+02
const sb1 = 3.03380607434824582924e+01
const sb2 = 3.25792512996573918826e+02
const sb3 = 1.53672958608443695994e+03
const sb4 = 3.19985821950859553908e+03
const sb5 = 2.55305040643316442583e+03
const sb6 = 4.74528541206955367215e+02
const sb7 = -2.24409524465858183362e+01

# Single precision erf()
function custom_erf32(x)
    xabs = abs(x)
    sgn = sign(x)
    oneval = one(x)
    val = sgn * one(x)

    if xabs < 0.84375f0
        z = x*x
        r = pp0s+z*(pp1s+z*(pp2s+z*(pp3s+z*pp4s)))
        s = oneval + z*(qq1s+z*(qq2s+z*(qq3s+z*(qq4s+z*qq5s))))
        y = r/s
        val = sgn * (xabs + xabs*y)
    elseif xabs < 1.25f0
        s = xabs-oneval
        P = pa0s+s*(pa1s+s*(pa2s+s*(pa3s+s*(pa4s+s*(pa5s+s*pa6s)))))
        Q = oneval+s*(qa1s+s*(qa2s+s*(qa3s+s*(qa4s+s*(qa5s+s*qa6s)))))
        val = sgn * (erxs + P/Q)
    elseif xabs < 2.857142857142857f0
        s = oneval/(x*x)
        R = ra0s+s*(ra1s+s*(ra2s+s*(ra3s+s*(ra4s+s*(ra5s+s*(ra6s+s*ra7s))))))
        S = oneval+s*(sa1s+s*(sa2s+s*(sa3s+s*(sa4s+s*(sa5s+s*(sa6s+s*(sa7s+s*sa8s)))))))
        r = exp(-x*x - 0.5625f0 + R/S)
        val = sgn * (oneval-r/xabs)
    elseif xabs < 6.0f0
        s = oneval/(x*x)
        R = rb0s+s*(rb1s+s*(rb2s+s*(rb3s+s*(rb4s+s*(rb5s+s*rb6s)))))
        S = oneval+s*(sb1s+s*(sb2s+s*(sb3s+s*(sb4s+s*(sb5s+s*(sb6s+s*sb7))))))
        r = exp(-x*x - 0.5625f0 + R/S)
        val = sgn * (oneval-r/xabs)
    end

    return val
end

# Double precision erf()
function custom_erf64(x)
    xabs = abs(x)
    sgn = sign(x)
    oneval = one(x)
    val = sgn * one(x)

    if xabs < 0.84375
        z = x*x
        r = pp0+z*(pp1+z*(pp2+z*(pp3+z*pp4)))
        s = oneval + z*(qq1+z*(qq2+z*(qq3+z*(qq4+z*qq5))))
        y = r/s
        val = sgn * (xabs + xabs*y)
    elseif xabs < 1.25
        s = xabs-oneval
        P = pa0+s*(pa1+s*(pa2+s*(pa3+s*(pa4+s*(pa5+s*pa6)))))
        Q = oneval+s*(qa1+s*(qa2+s*(qa3+s*(qa4+s*(qa5+s*qa6)))))
        val = sgn * (erx + P/Q)
    elseif xabs < 2.857142857142857
        s = oneval/(x*x)
        R = ra0+s*(ra1+s*(ra2+s*(ra3+s*(ra4+s*(ra5+s*(ra6+s*ra7))))))
        S = oneval+s*(sa1+s*(sa2+s*(sa3+s*(sa4+s*(sa5+s*(sa6+s*(sa7+s*sa8)))))))
        r = exp(-x*x - 0.5625 + R/S)
        val = sgn * (oneval-r/xabs)
    elseif xabs < 6.0
        s = oneval/(x*x)
        R = rb0+s*(rb1+s*(rb2+s*(rb3+s*(rb4+s*(rb5+s*rb6)))))
        S = oneval+s*(sb1+s*(sb2+s*(sb3+s*(sb4+s*(sb5+s*(sb6+s*sb7))))))
        r = exp(-x*x - 0.5625 + R/S)
        val = sgn * (oneval-r/xabs)
    end

    return val
end

custom_erf(x::Float64) = custom_erf64(x)
custom_erf(x::Float32) = custom_erf32(x)

# For ForwardDiff compatibility
custom_erf(x::ForwardDiff.Dual{<:Any, Float64, <:Any}) = custom_erf64(x)
custom_erf(x::ForwardDiff.Dual{<:Any, Float32, <:Any}) = custom_erf32(x)

# NVIDIA CUDA variants of erf()
@inline Cuerf(x::Float64) = ccall("extern __nv_erf", llvmcall, Cdouble, (Cdouble,), x)
@inline Cuerf(x::Float32) = ccall("extern __nv_erff", llvmcall, Cfloat, (Cfloat,), x)
